const { Client, LocalAuth } = require('whatsapp-web.js');  // Importa o Client e LocalAuth
const qrcode = require('qrcode-terminal');  // Para gerar o QR Code no terminal
const client = new Client({
    authStrategy: new LocalAuth(),  // Usa o LocalAuth para armazenar a autentica√ß√£o
});

// Lista de IDs dos administradores autorizados a usar os comandos
const adminsList = [
    '556281206530@c.us', // ID de um administrador
    '552798708362@c.us',
    '558393214736@c.us',
    '558396668109@c.us',
    '554799560456@c.us',
];

let userLinkAttempts = {};  // Armazena a quantidade de links enviados por cada usu√°rio

client.on('qr', (qr) => {
    // Quando o QR Code for gerado, exibe no terminal
    qrcode.generate(qr, { small: true });
    console.log('QR Code gerado. Escaneie para autenticar.');
});

client.on('ready', () => {
    // Quando o bot estiver pronto, informa no console
    console.log('Bot est√° pronto!');
});

client.on('ready', async () => {
    // Quando o bot estiver online, envia uma mensagem em todos os grupos
    console.log('Bot est√° online e pronto!');

    // Itera sobre todos os chats do bot
    const chats = await client.getChats();
    
    // Filtra os chats para garantir que seja um grupo (com '@g.us' no ID)
    const groupChats = chats.filter(chat => chat.isGroup);
    
    // Mensagem que o bot vai enviar quando ficar online
    const welcomeBotMessage = "üö® O bot do Zorin ta on piazada üö®";

    // Envia a mensagem em todos os grupos
    for (let chat of groupChats) {
        await chat.sendMessage(welcomeBotMessage);
    }

    console.log("Mensagem enviada para todos os grupos.");
});



client.on('message', async (msg) => {
    // Exibe log detalhado de cada mensagem recebida
    console.log(`Mensagem recebida de ${msg.from}: ${msg.body}`);
    console.log(`ID do remetente: ${msg.author || msg.from}`); // Aqui mostramos o ID da pessoa que enviou a mensagem

    // Comando !ping
    if (msg.body == '/ping') {
        msg.reply('T√¥ aqui seu Jaguar√°');
    }

    // Comando !lock - Apenas administradores podem usar
    if (msg.body == '/lock') {
        // Verifica se a mensagem foi enviada em um grupo
        if (msg.from.endsWith('@g.us')) {  // Verifica se √© um grupo (IDs de grupos terminam com '@g.us')
            // Obt√©m o chat do grupo
            const chat = await msg.getChat();

            // Verifica se o chat √© um grupo
            if (chat.isGroup) {
                // Obt√©m a lista de participantes do grupo
                const participants = chat.participants;

                // Inicializa isAdmin como falso
                let isAdmin = adminsList.includes(msg.from);  // Verifica se o ID do remetente est√° na lista de administradores
                
                // Caso o ID n√£o esteja na lista de administradores, vamos buscar a lista de administradores no grupo
                if (!isAdmin) {
                    const adminInGroup = participants.some(participant => 
                        adminsList.includes(participant.id._serialized) && participant.isAdmin
                    );

                    if (adminInGroup) {
                        isAdmin = true;
                    }
                }

                if (isAdmin) {
                    // Altera a configura√ß√£o do grupo para permitir somente administradores enviarem mensagens
                    await chat.setMessagesAdminsOnly(true);
                    msg.reply('Somente administradores podem agora enviar mensagens.');
                    console.log('Configura√ß√£o alterada para permitir apenas administradores no grupo:', chat.id);
                } else {
                    msg.reply('Voc√™ n√£o tem permiss√£o para usar este comando. Apenas administradores podem.');
                }
            } else {
                msg.reply('Este comando s√≥ pode ser usado em grupos.');
            }
        } else {
            msg.reply('Este comando s√≥ pode ser usado em grupos.');
        }
    }

    // Comando !unlock - Permite que todos os membros do grupo enviem mensagens
    if (msg.body == '/unlock') {
        // Verifica se a mensagem foi enviada em um grupo
        if (msg.from.endsWith('@g.us')) {  // Verifica se √© um grupo (IDs de grupos terminam com '@g.us')
            // Obt√©m o chat do grupo
            const chat = await msg.getChat();

            // Verifica se o chat √© um grupo
            if (chat.isGroup) {
                // Inicializa isAdmin como falso
                let isAdmin = adminsList.includes(msg.author);  // Verifica se o ID do remetente est√° na lista de administradores
                
                if (!isAdmin) {
                    msg.reply('Voc√™ n√£o tem permiss√£o para usar este comando. Apenas administradores podem.');
                    return;
                }

                // Altera a configura√ß√£o do grupo para permitir todos os membros enviarem mensagens
                await chat.setMessagesAdminsOnly(false);
                msg.reply('Agora todos os membros podem enviar mensagens no grupo.');
                console.log('Configura√ß√£o alterada para permitir todos os membros no grupo:', chat.id);
            } else {
                msg.reply('Este comando s√≥ pode ser usado em grupos.');
            }
        } else {
            msg.reply('Este comando s√≥ pode ser usado em grupos.');
        }
    }

    // Comando !ban - Banir usu√°rio
    if (msg.body.startsWith('/ban')) {
        const mentionedUsers = msg.mentionedUsers;
        if (mentionedUsers.length > 0) {
            const chat = await msg.getChat();
            await chat.removeParticipants([mentionedUsers[0]]);
            msg.reply('Usu√°rio banido do grupo.');
            console.log(`Usu√°rio ${mentionedUsers[0]} banido.`);
        } else if (msg.hasQuotedMsg) {
            const quotedMsg = await msg.getQuotedMessage();
            const quotedUser = quotedMsg.author;
            const chat = await msg.getChat();
            await chat.removeParticipants([quotedUser]);
            msg.reply('Usu√°rio banido do grupo.');
            console.log(`Usu√°rio ${quotedUser} banido.`);
        } else {
            msg.reply('Voc√™ precisa mencionar o usu√°rio ou responder a uma mensagem para banir.');
        }
    }

    // Anti-links - Apaga mensagens com links e remove usu√°rios que enviarem mais de 3 links
    if (!adminsList.includes(msg.author)) {  // Ignora verifica√ß√µes para administradores
        const urlRegex = /(https?:\/\/[^\s]+)/g; // Express√£o regular para detectar URLs

        if (urlRegex.test(msg.body)) {  // Se a mensagem contiver um link
            // Apaga a mensagem para todos os participantes
            try {
                await msg.delete(true);  // Deleta a mensagem com link para todos
                msg.reply('Links n√£o s√£o permitidos neste grupo.');
                console.log(`Mensagem deletada de ${msg.author} por conter link.`);
            } catch (error) {
                console.log('Erro ao tentar deletar a mensagem:', error);
            }

            // Se o usu√°rio ainda n√£o estiver na contagem de tentativas
            if (!userLinkAttempts[msg.author]) {
                userLinkAttempts[msg.author] = 0;
            }

            // Incrementa a contagem de links enviados pelo usu√°rio
            userLinkAttempts[msg.author]++;

            // Se o usu√°rio enviar mais de 3 links
            if (userLinkAttempts[msg.author] > 3) {
                try {
                    // Remove o usu√°rio do grupo
                    const chat = await msg.getChat();
                    await chat.removeParticipants([msg.author]);
                    msg.reply('Voc√™ foi removido do grupo por enviar muitos links.');
                    console.log(`Usu√°rio ${msg.author} removido do grupo por enviar mais de 3 links.`);
                } catch (error) {
                    msg.reply('Houve um erro ao tentar remover o usu√°rio.');
                    console.log('Erro ao remover o usu√°rio:', error);
                }
            }
        }
    }

    // Comando /gostoso - Escolhe um usu√°rio aleat√≥rio e menciona
    if (msg.body == '/gostoso') {
        if (msg.from.endsWith('@g.us')) {  // Verifica se √© um grupo (IDs de grupos terminam com '@g.us')
            const chat = await msg.getChat();
            const participants = chat.participants;  // Inclui todos os participantes, sem filtrar administradores
            const randomUser = participants[Math.floor(Math.random() * participants.length)];  // Escolhe um participante aleat√≥rio
            const randomPercentage = Math.floor(Math.random() * 101);  // Gera uma porcentagem aleat√≥ria entre 0 e 100

            // Obt√©m o ID do participante para usar na men√ß√£o
            const userId = randomUser.id._serialized;

            // Menciona o usu√°rio aleat√≥rio com a sintaxe de men√ß√£o do WhatsApp
            chat.sendMessage(`Boy @${randomUser.id.user} √© ${randomPercentage}% gostoso uiiii quem ai ser√° o mais gostoso do cabar√©???`);

            console.log(`Mensagem de entretenimento enviada mencionando @${randomUser.id.user}.`);
        }
    }

    // Comando /corno - Escolhe um usu√°rio aleat√≥rio e menciona
    if (msg.body == '/corno') {
        if (msg.from.endsWith('@g.us')) {  // Verifica se √© um grupo (IDs de grupos terminam com '@g.us')
            const chat = await msg.getChat();
            const participants = chat.participants;  // Inclui todos os participantes
            const randomUser = participants[Math.floor(Math.random() * participants.length)];  // Escolhe um participante aleat√≥rio
            const randomPercentage = Math.floor(Math.random() * 101);  // Gera uma porcentagem aleat√≥ria entre 0 e 100

            // Obt√©m o ID do participante para usar na men√ß√£o
            const userId = randomUser.id._serialized;

            // Menciona o usu√°rio aleat√≥rio com a sintaxe de men√ß√£o do WhatsApp e adiciona o "emote de vaca"
            chat.sendMessage(`Esse √© @${randomUser.id.user} e ele √© ${randomPercentage}% corno muuuu üêÑ`);

            console.log(`Mensagem de entretenimento enviada mencionando @${randomUser.id.user}.`);
        }
    }



    // Comando /shipp - Junta dois usu√°rios aleat√≥rios e gera uma porcentagem
    if (msg.body == '/shipp') {
    if (msg.from.endsWith('@g.us')) {  // Verifica se √© um grupo (IDs de grupos terminam com '@g.us')
        const chat = await msg.getChat();
        const participants = chat.participants;  // Inclui todos os participantes
        const randomUser1 = participants[Math.floor(Math.random() * participants.length)];  // Escolhe o primeiro participante aleat√≥rio
        const randomUser2 = participants[Math.floor(Math.random() * participants.length)];  // Escolhe o segundo participante aleat√≥rio

        // Evita escolher a mesma pessoa para ambos os participantes
        if (randomUser1.id._serialized === randomUser2.id._serialized) {
            return msg.reply('Os dois participantes n√£o podem ser a mesma pessoa! Tentando novamente...');
        }

        const randomPercentage = Math.floor(Math.random() * 101);  // Gera uma porcentagem aleat√≥ria entre 0 e 100

        // Envia a mensagem mencionando ambos os participantes e a porcentagem
        chat.sendMessage(`O @${randomUser1.id.user} e o @${randomUser2.id.user} formam um belo casal com ${randomPercentage}% de compatibilidade! ‚ù§Ô∏è`);

        console.log(`Mensagem de shipp enviada mencionando @${randomUser1.id.user} e @${randomUser2.id.user}.`);
        }
    }

});


// Comando /menu - Exibe a lista de comandos dispon√≠veis
client.on('message', async (msg) => {
    if (msg.body == '/menu') {
        const isAdmin = adminsList.includes(msg.author);  // Verifica se o remetente est√° na lista de administradores

        let menuMessage = 'üéâ **Comandos dispon√≠veis** üéâ\n\n';

        if (isAdmin) {
            // Se for admin, exibe todos os comandos com emojis e negrito
            menuMessage += 'üîí **/lock** - Bloqueia o envio de mensagens no grupo para admins.\n';
            menuMessage += 'üîì **/unlock** - Desbloqueia o envio de mensagens no grupo para todos.\n';
            menuMessage += 'üö´ **/ban @usuario** - Banir um usu√°rio do grupo.\n';
            menuMessage += 'üíã **/gostoso** - Marcar algu√©m aleat√≥rio como gostoso.\n';
            menuMessage += 'üëë **/corno** - Marcar algu√©m aleat√≥rio como corno.\n';
            menuMessage += 'üíë **/shipp** - Encontre um casal aleat√≥rio.\n';
            menuMessage += 'üì≤ **/all** - Marca todos os participantes no grupo.\n';
            menuMessage += 'ü§≥ **/fig** - Cria uma figurinha ao responder uma foto.\n';
            menuMessage += 'üìú **/regras** - Lista as regras do grupo.\n';
        } else {
            // Se n√£o for admin, exibe apenas os comandos p√∫blicos
            menuMessage += 'üíã **/gostoso** - Marcar algu√©m aleat√≥rio como gostoso.\n';
            menuMessage += 'üëë **/corno** - Marcar algu√©m aleat√≥rio como corno.\n';
            menuMessage += 'üíë **/shipp** - Encontre um casal aleat√≥rio.\n';
            menuMessage += 'üì≤ **/menu** - Exibe esta lista de comandos.\n';
            menuMessage += 'ü§≥ **/fig** - Cria uma figurinha ao responder uma foto.\n';
            menuMessage += 'üìú **/regras** - Lista as regras do grupo.\n';
        }

        // Envia a mensagem com formata√ß√£o mais bonita
        msg.reply(menuMessage);
    }
});



client.on('message', async (msg) => {
    // Verifica se a mensagem √© uma resposta e se a mensagem original cont√©m m√≠dia
    if (msg.body === '/fig' && msg.hasQuotedMsg) {
        const quotedMsg = await msg.getQuotedMessage();  // Obt√©m a mensagem original citada

        // Verifica se a mensagem original √© uma m√≠dia (foto, v√≠deo, etc.)
        if (quotedMsg.hasMedia) {
            const media = await quotedMsg.downloadMedia();  // Baixa a m√≠dia da mensagem citada

            // Envia a m√≠dia como sticker
            client.sendMessage(msg.from, media, { sendMediaAsSticker: true });

           
        } else {
            // Caso a mensagem citada n√£o seja uma foto ou m√≠dia
            msg.reply('Por favor, responda a uma foto com o comando /fig.');
        }
    }
});


// Evento para detectar quando algu√©m entra no grupo
client.on('group_participants', async (notification) => {
    // Verifica se a a√ß√£o foi "entrando" no grupo
    if (notification.action === 'add') {
        const groupId = notification.chat.id;
        const newParticipant = notification.participants[0];

        // Mensagem de boas-vindas detalhada
        const welcomeMessage = `üéâ Bem-vindo(a) ao grupo, @${newParticipant}!\n\n` +
            "ENTROU, SE APRESENTA üì∏\n\n" +
            "Foto:\n" +
            "Nome:\n" +
            "Idade:\n" +
            "Cidade:\n\n" +
            "Use /menu para ver a lista de comandos\n" +
            "Se divirta! üòé";

        // Envia a mensagem de boas-vindas com a men√ß√£o ao novo membro
        await client.sendMessage(groupId, welcomeMessage, { mentions: [newParticipant] });
    }
});

client.on('message', async (msg) => {
    // Comando /regras para enviar as regras do grupo
    if (msg.body === '/regras') {
        const regras = `üö´ PROIBIDO üö´ 

Ir no PV dos ADMS sem permiss√£o ü§ôüèª

Racismo 

Homofobia 

Gordofobia

E qualquer tipo de preconceito 

Discuss√£o politica

Apenas 14 anos +

Proibido Amea√ßas

Proibido apologia ao nazismo/racismo

Proibido qualquer tipo de intoler√¢ncia seja religiosa ou n√£o.

Idade m√°xima 35 anos 

Proibido nudes 

| Se divertir

Proibido divulgar links e etc...

* REGRAS DO GRUPO 
* ‚Å†respeita os adms 
* ‚Å†respeita o pr√≥ximo 
* ‚Å†respeita as regras
* ‚Å†se apresentar 
* ‚Å†e se divertir`;

        // Envia as regras no grupo
        await msg.reply(regras);
    }
});

// Quando algu√©m entra no grupo, envia a mensagem de boas-vindas
client.on('group_join', async (notification) => {
    // Obt√©m informa√ß√µes sobre o grupo e o usu√°rio que entrou
    const chat = await notification.getChat();
    const newMember = notification.participants[0];  // O ID do novo membro

    // Mensagem de boas-vindas
    const welcomeMessage = `üéâ **Bem-vindo(a), ${newMember.split('@')[0]}!** üéâ\n\n` +
        'Seja muito bem-vindo(a) ao nosso grupo! üòÑ\n\n' +
        'ENTROU SE APRESENTA üì∏\n\n' +
        '**Foto:**\n' +
        '**Nome:**\n' +
        '**Idade:**\n' +
        '**Cidade:**\n\n' +
        'Para saber mais sobre o grupo, use **/menu** para ver todos os comandos dispon√≠veis!\n\n' +
        'Estamos felizes em ter voc√™ aqui, aproveite! üéä\n\n' +
        'Lembre-se de seguir as **regras do grupo** para garantir que todos se divirtam juntos! üëå';

    // Envia a mensagem de boas-vindas no grupo
    await chat.sendMessage(welcomeMessage);
});


client.on('message', async (message) => {
    if (message.body === '/all') { // Comando para mencionar todos
        // Verifica se o remetente est√° na lista de administradores
        if (!adminsList.includes(message.author)) {
            message.reply('‚ùå Voc√™ n√£o tem permiss√£o para usar este comando.');
            return;
        }

        const chat = await message.getChat();

        if (chat.isGroup) {
            const mentions = [];
            let text = 'üëã Ol√°, @todos!';

            // Coleta todos os participantes do grupo
            for (let participant of chat.participants) {
                const contact = await client.getContactById(participant.id._serialized);
                mentions.push(contact); // Adiciona na lista de men√ß√µes
                text += `\n@${contact.number}`; // Adiciona o n√∫mero √† mensagem
            }

            // Envia a mensagem com men√ß√µes
            chat.sendMessage(text, { mentions });
        } else {
            message.reply('Este comando s√≥ pode ser usado em grupos!');
        }
    }
});




client.initialize();

